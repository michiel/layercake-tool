# Investigation: UI Sync Issues and Projection Opening Failures

**Date**: 2026-01-28
**Status**: Investigation Complete

---

## Issue 1: Plan DAG Canvas Out of Sync

### Summary

The plan DAG canvas uses a CQRS-based synchronisation system with delta updates via JSON Patch. While efficient, this architecture has multiple race conditions and timing dependencies that cause the UI to become out of sync with backend state.

### Architecture Overview

```
GraphQL Mutations (Commands)
    ↓
PlanDagCommandService (marks mutation timestamp)
    ↓
Apollo Client Cache Update
    ↓
Subscription Server (publishes delta)
    ↓
PlanDagDeltaChanged Subscription
    ↓
PlanDagQueryService (applies JSON Patch)
    ↓
usePlanDagCQRS Hook (setPlanDag)
    ↓
ReactFlow State (conversion via adapter)
    ↓
Canvas Rendering
```

### Key Files

| Component | File | Key Lines |
|---|---|---|
| CQRS Orchestration | `PlanDagCQRSService.ts` | 16-50, 185-200, 203-216 |
| Query Service | `PlanDagQueryService.ts` | 89-181, 246-286 |
| Command Service | `PlanDagCommandService.ts` | 20-27, 30-57 |
| State Management Hook | `usePlanDagCQRS.ts` | 108-135, 240-389, 424-478 |
| UI Component | `PlanVisualEditor.tsx` | 114-208, 219-244, 380-422, 439-505, 1686-1751 |

### Race Conditions Identified

| Race Condition | Location | Trigger | Impact | Severity |
|---|---|---|---|---|
| Subscription during drag | `usePlanDagCQRS.ts:248` | Drag + subscription simultaneous | Stale position | HIGH |
| Echo suppression timeout | `PlanDagQueryService.ts:121` | Slow network + fast subscription | Infinite loop or missed updates | CRITICAL |
| Double render React 18 | `usePlanDagCQRS.ts:240-250` | Strict mode development | Inconsistent state | MEDIUM |
| setState lag + timestamp check | `PlanDagCommandService.ts:20-27` | Network latency > 500ms | Echo not suppressed | MEDIUM |
| Stable ref async mismatch | `usePlanDagCQRS.ts:539-545` | Concurrent subscriptions | Out-of-sync state | HIGH |
| Node merge identity | `usePlanDagCQRS.ts:340-352` | Position + data change together | Lost updates | MEDIUM |
| External sync flag timing | `usePlanDagCQRS.ts:384` | setTimeout(0) macrotask delay | Missed updates | MEDIUM |
| Multiple subscription handlers | `usePlanDagCQRS.ts:425+448` | Both firing simultaneously | Data race | HIGH |

### Out-of-Sync Scenarios

#### Scenario A: Node Position Never Syncs
1. User drags node to new position
2. Drag completes, position mutation sent
3. Subscription arrives before `setDragging(false)` completes (< 100ms)
4. Update skipped (`isDragging = true`)
5. setTimeout completes, `isDragging = false`
6. But subscription already arrived and was skipped
7. Position stays stale (won't receive another subscription for same position)

#### Scenario B: Collaborative Edit Lost
1. User A modifies node config → mutation + echo suppression active
2. User B's subscription arrives with their change to different node
3. Echo window still active, subscription skipped
4. Both changes don't appear

#### Scenario C: Execution Status Never Appears
1. Plan execution starts, backend updates node with executionState
2. executionStatusSubscription fires (line 448)
3. Updates only nodes in planDag, doesn't trigger ReactFlow conversion
4. Execution state visible in planDag but not displayed on canvas

### Recommendations

#### 1. Add Subscription Retry After Drag Ends

**Location**: `PlanVisualEditor.tsx:439-505`

After `setDragging(false)`, emit a signal to refetch missed subscriptions, or increase the 100ms re-enable delay to 300-500ms.

#### 2. Per-Node Echo Suppression

**Location**: `PlanDagQueryService.ts`

Currently echo suppression is global (any mutation blocks all subscriptions). Track mutation timestamps per node ID to allow updates to other nodes through.

```typescript
// Current
private lastMutationTimestamp: number = 0

// Recommended
private lastMutationTimestamps: Map<string, number> = new Map()
```

#### 3. Replace setTimeout(0) with Microtask

**Location**: `usePlanDagCQRS.ts:384`

```typescript
// Current (risky - macrotask queue)
setTimeout(() => { editorStateRef.current.sync.isExternalSync = false }, 0)

// Recommended (tighter timing - microtask queue)
queueMicrotask(() => { editorStateRef.current.sync.isExternalSync = false })
```

#### 4. Serialise Subscription Handlers

**Location**: `usePlanDagCQRS.ts:424-478`

Use a mutex/queue to prevent delta and execution subscriptions from racing. Or consolidate into a single subscription that handles both update types.

#### 5. Add Full State Refresh as Fallback

If change detection shows persistent mismatch (>3 consecutive syncs fail), trigger `getPlanDag({ fresh: true })`. Consider adding a manual "refresh canvas" button for users.

#### 6. Enhanced Logging for Debugging

Add a debug mode that logs:
- Every subscription received with timestamp
- Every echo suppression decision
- Every sync skip with reason

---

## Issue 2: Projections Not Opening in Tauri Release Builds

### Summary

Projections fail to open in Tauri release builds due to differences between development and release environments, primarily around dynamic port allocation, permissions, and asset paths.

### Root Causes Identified

| Issue | Dev Mode | Release Mode | Impact |
|---|---|---|---|
| Server port | Via env vars at build time | Dynamic allocation at runtime | Wrong port used |
| Permissions | Lenient | Strict capability enforcement | Window creation rejected |
| Asset paths | cwd = project root | cwd = src-tauri/ | 404 errors |
| Event handling | Errors often visible | Silent failures | No feedback to user |
| API connection | Env vars available | Runtime values needed | GraphQL fails |

### Key Files

**Tauri Configuration:**
- `src-tauri/tauri.conf.json` - Main config
- `src-tauri/capabilities/dev.json` - Dev permissions
- `src-tauri/capabilities/projection-windows.json` - Projection window permissions

**Backend Server:**
- `src-tauri/src/server.rs` - Dynamic port allocation (line 67: port 0)
- `src-tauri/src/main.rs` - AppState management, `get_server_info()` command
- `layercake-server/src/server/app.rs` - Asset serving and path resolution

**Frontend:**
- `frontend/src/utils/tauri.ts` - Tauri bridge utilities
- `frontend/src/pages/workbench/ProjectionsPage.tsx` (lines 147-179)
- `frontend/src/components/editors/PlanVisualEditor/nodes/ProjectionNode.tsx` (lines 90-126)
- `frontend/src/pages/workbench/ProjectArtefactsPage.tsx` (lines 229-263)
- `projections-frontend/src/main.tsx` - Viewer bootstrap (lines 12-19)

### Issues in Detail

#### Issue 2.1: Missing Tauri Permissions

The dev capability file was missing `core:webview:allow-create-webview-window`. Without this, `WebviewWindow` constructor calls fail silently in release mode.

**Fix**: Created `src-tauri/capabilities/projection-windows.json` with appropriate permissions.

#### Issue 2.2: Incorrect Server URL Configuration

The projection viewer URL was hardcoded:
```typescript
// Broken
const apiBase = import.meta.env?.VITE_API_BASE_URL || 'http://localhost:3001'
```

In release builds, the embedded server starts on a dynamically allocated port (port 0), making hardcoded ports wrong.

**Fix**: Use `getServerInfo()` Tauri command to get the actual runtime port.

#### Issue 2.3: Incorrect Event Handling

Tauri v2 requires explicit event listeners for window lifecycle:
```typescript
win.once('tauri://created', () => { ... })
win.once('tauri://error', (e) => { ... })
```

Without these, window creation failures are silent.

#### Issue 2.4: Projection Viewer Cannot Connect

The projection viewer frontend needs the server URL passed via query parameter since environment variables aren't available at runtime:
```typescript
const url = `${serverInfo.url}/projections/viewer/${id}?apiBase=${encodeURIComponent(serverInfo.url)}`
```

#### Issue 2.5: Asset Serving Path Misconfiguration

When the Tauri binary runs, cwd is `src-tauri/`, not the project root. The server must detect this and adjust paths accordingly.

**Fix** (in `app.rs`):
```rust
if projections_path.ends_with("src-tauri") {
    projections_path = projections_path.parent().unwrap_or(&projections_path).to_path_buf();
}
```

### Current Status

Commit `853361c3` appears to have addressed most of these issues.

### Recommendations

#### 1. Verify Permission Configuration

Ensure `src-tauri/capabilities/projection-windows.json` includes:
- `core:webview:allow-create-webview-window`
- `core:default`
- `core:window:default`
- `core:webview:default`

#### 2. Verify Dynamic Port Propagation

Check all three projection opening locations use `getServerInfo()`:
- `ProjectionsPage.tsx:147-179`
- `ProjectionNode.tsx:90-126`
- `ProjectArtefactsPage.tsx:229-263`

#### 3. Add Explicit Error Handling

```typescript
win.once('tauri://error', (e: unknown) => {
  console.error('[Projection] Window creation failed:', e)
  showErrorNotification('Open failed', String(e))
})
```

#### 4. Test Specific Scenarios

1. Build release: `cargo tauri build`
2. Run the release binary directly (not via `cargo tauri dev`)
3. Open projections from all three entry points
4. Check console for network errors to wrong port

#### 5. Add Server Info Diagnostics

- Log the server URL on startup in release mode
- Add a health check endpoint that projection windows can verify before loading

#### 6. Path Robustness

Verify the src-tauri cwd detection works on all platforms. Consider using `CARGO_MANIFEST_DIR` or embedding assets in the binary for more reliable path resolution.

---

## Summary

| Issue | Severity | Status | Effort to Fix |
|---|---|---|---|
| DAG canvas sync | HIGH | Open | Medium-High |
| Projection opening | HIGH | Mostly Fixed (verify) | Low |

The DAG sync issues require architectural changes to the CQRS synchronisation system. The projection opening issues appear to be addressed but should be verified with release build testing.
